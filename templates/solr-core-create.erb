#!/bin/bash

# creates a new Solr core
if [ "$1" = "" ]; then
    echo -n "Name of core to create: "
    read name
else
    name=$1
fi

/usr/sbin/solr-core-exists $name

if [ $? == 0 ]; then
    echo "Cannot create $name: core with same name already exists"
    exit 1
fi

mkdir -p <%= scope.lookupvar('solr::params::conf') %>/$name/conf
cp -a <%= scope.lookupvar('solr::params::conftemplate') %>/* <%= scope.lookupvar('solr::params::conf') %>/$name/conf/
chown -R <%= scope.lookupvar('solr::common::user') %>:<%= scope.lookupvar('solr::common::group') %> <%= scope.lookupvar('solr::params::conf') %>/$name

sed -i "s/CORENAME/$name/" <%= scope.lookupvar('solr::params::conf') %>/$name/conf/solrconfig.xml

curl "http://localhost:8080/solr/admin/cores?action=CREATE&name=$name&instanceDir=<%= scope.lookupvar('solr::params::conf') %>/$name"

exit $?